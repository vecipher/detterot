name: ci
on: [push, pull_request]

jobs:
  checks:
    strategy:
      matrix:
        os: [ubuntu-22.04, macos-14]
        toolchain: [stable]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.toolchain }}
      - uses: Swatinem/rust-cache@v2
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libasound2-dev pkg-config
      - run: cargo fmt --all -- --check
      - run: cargo clippy --all-targets --all-features -- -D warnings
      - run: cargo test --all --all-features

  determinism:
    needs: checks
    strategy:
      matrix:
        os: [ubuntu-22.04, macos-14]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@v2
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libasound2-dev pkg-config
      - name: Record deterministic goldens
        run: |
          set -euo pipefail
          mkdir -p target/m2-records
          record() {
            cargo run -p game --features deterministic -- --mode record --io "target/m2-records/$1.json" \
              --fixed-dt 0.0333333333 --headless --world-seed "$2" --link-id "$3" \
              --weather "$4" --pp "$5" --day 1
          }
          record leg_seed_01 1001 1 Clear 5000
          record leg_seed_02 1002 2 Fog 4200
          record leg_seed_03 1003 3 Rains 3100
          record leg_seed_04 1004 4 Windy 6000
          record leg_seed_05 1005 5 Clear 2000
      - name: Compare hashes against checked-in goldens
        run: |
          set -euo pipefail
          for idx in 01 02 03 04 05; do
            diff -u "repro/records/leg_seed_${idx}.hash" "target/m2-records/leg_seed_${idx}.hash"
          done
      - name: Replay checked-in goldens
        run: |
          set -euo pipefail
          for idx in 01 02 03 04 05; do
            cargo run -p game --features deterministic -- --mode replay \
              --io "repro/records/leg_seed_${idx}.json" --fixed-dt 0.0333333333 \
              --headless --stop-on-mismatch
          done
      - name: Determinism guard
        run: ci/grep_banned_random.sh
      - name: Upload recorded outputs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: m2-records-${{ matrix.os }}
          path: target/m2-records

  econ_goldens:
    needs: checks
    strategy:
      matrix:
        os: [ubuntu-22.04, macos-14]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@v2
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libasound2-dev pkg-config
      - name: Run econ sim tests
        run: cargo test -p econ-sim -- --nocapture
      - name: Produce econ curves
        run: >
          cargo run -p econ-sim -- --world-seed 42 --days 15 --hubs 3
          --pp 1500,5000,9000 --debt 0,500_000_00,5_000_000_00 --out target/econ_curves.csv
      - name: Diff econ CSV
        run: ci/scripts/diff_csv.sh crates/econ_sim/tests/goldens/econ_curves_seed42.csv target/econ_curves.csv
      - name: Economy float audit
        run: |
          CLIPPY_CONF_DIR=ci cargo clippy -p game --lib -- -D warnings
